{% set params = app.request.attributes.get('_route_params')|merge(app.request.query.all()) %}
{% block header %}
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="description" content="Axiom Business Management" />
	<meta name="author" content="" />
	<link rel="icon" href="images/favicon.ico">
	{{ include('@Globale/header.html.twig') }}

{% endblock %}
<title>{% block title %}{{ interfaceName }}{% endblock %}</title>
<body class="page-body" data-url="{{ url('indexAdmin') }}">
<div class="page-container {% if userData.interfaceConfig.collapsedSidebar is defined and userData.interfaceConfig.collapsedSidebar %}sidebar-collapsed{% endif %}"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
	{{ include('@Globale/sidebar_menu.html.twig') }}
	<div class="main-content">
		{{ include('@Globale/head.html.twig') }}
		<hr />
		{{ include('@Globale/breadcrumb.html.twig') }}
		<h2>{{ interfaceName }}</h2>
		</br>
		<!-- MAIN CONTENT -->



    <div class="calendar-env">
    			<!-- Calendar Body -->
    			<div class="calendar-body">
    				<div id="calendar"></div>
    			</div>
    			<!-- Sidebar -->
    			<div class="calendar-sidebar">
    				<!-- new task form -->
    				<div class="calendar-sidebar-row">
    					<form role="form" id="add_event_form">
    							<button class="btn btn-success btn-icon icon-left center-block" data-toggle="modal" data-target="#calendar-modal-new-event" placeholder="Nuevo evento">Nuevo Evento<i class="fa fa-plus"></i></button>
    					</form>
    				</div>

    				<!-- Calendar List -->
    				<ul class="calendar-list events-list" id="calendar-list">
    					<li>
    						<p>Mis Calendarios</p>
    					</li>

    				</ul>

							<div class="calendar-sidebar-row">
								<button attr-url="" href="javascript:void(0);" class="btn btn-default btn-icon icon-left center-block" data-toggle="modal" data-target="#calendar-modal-new-calendar">
									Nuevo Calendario<i class="fa fa-plus"></i>
								</button>

							</div>

					</br></br>
    			</div>
    	</div>


		<!-- END MAIN CONTENT -->
		{{ include('@Globale/footer.html.twig') }}
	</div>
	{{ include('@Globale/chat.html.twig') }}
	<!-- Chat Histories -->
	{{ include('@Globale/chat_histories.html.twig') }}
</div>
	<!-- MODALS  -->

<!-- New Calendar -->
<div class="modal fade" tabindex="-1" id="calendar-modal-new-calendar" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content" style="transform: matrix(1, 0, 0, 1, 0, 0);">
				<div class="modal-header">
					<h4 class="modal-title">Nuevo calendario</h4>
				</div>
				<div id="calendar-modal-new-calendar-body" class="modal-body">
					<div class="panel-body">
					<form id="calendar-modal-new-calendar-form">
						<input type="hidden" class="form-control" id="calendarId" name="calendarId">
						<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label for="name" class="control-label">Nombre</label>
										<input type="text" class="form-control" id="calendarName" name="calendarName" placeholder="Nombre">
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label for="color" class="control-label">Color</label>
										<input type="text" class="form-control" id="calendarColor" name="calendarColor" value="#0000FF">
									</div>
								</div>
						</div>
					</form>
				</div>
				</br></br>
				</div>
				<div id="calendar-modal-new-calendar-footer" class="modal-footer">
					<button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
					<button attr-id="" attr-action="" id="calendar-modal-new-calendar-button-continue" type="button" class="btn btn-red">Guardar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- New Event -->
	<div class="modal fade" tabindex="-1" id="calendar-modal-new-event" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content" style="transform: matrix(1, 0, 0, 1, 0, 0);">
					<div class="modal-header">
						<h4 class="modal-title">Evento</h4>
					</div>
					<div id="calendar-modal-new-event-body" class="modal-body">
						<div class="panel-body">
						<form id="calendar-modal-new-event-form">
							<input type="hidden" class="form-control" id="eventId" name="eventId">
							<div class="row">
									<div class="col-md-12">
										<div class="form-group">
											<label for="eventTitle" class="control-label">Titulo</label>
											<input type="text" class="form-control" id="eventTitle" name="eventTitle" placeholder="Nombre">
										</div>
									</div>
							</div>
							<div class="row">
									<div class="col-md-2">
										<div class="form-group">
											<label for="eventAllDay" class="control-label">Todo el día</label>
											<div class="checkbox checkbox-replace">
												<input type="checkbox" class="form-control" id="eventAllDay" name="eventAllDay">
											</div>
										</div>
									</div>
									<div class="col-md-10">
										<div class="form-group">
											<label for="eventLocation" class="control-label">Ubicación</label>
											<input type="text" class="form-control" id="eventLocation" name="eventLocation" placeholder="Ubicación">
										</div>
									</div>
							</div>
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="control-label" for="eventCalendar">Calendario:</label>

											<select name="eventCalendar" id="eventCalendar" class="selectboxit">
												<optgroup label="Cuentas de correo">
												</optgroup>
											</select>

									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label for="color" class="control-label">Color</label>
										<input type="text" class="form-control" id="eventColor" name="eventColor" value="">
									</div>
								</div>
							</div>
							<div class="row">
									<div class="col-md-6">
										<div class="form-group">
											<label class="col-sm-3 control-label">Inicio</label>
											<div class="col-sm-12" style="padding: 0px 0px !important; margin-bottom:15px">
												<div class="date-and-time">
													<input type="text" id="eventStartDate" name="eventStartDate" class="form-control datepicker" data-format="dd/mm/yyyy">
													<input type="text" id="eventStartTime" name="eventStartTime"  class="form-control timepicker" data-template="dropdown" data-show-seconds="false" data-default-time="23:00" data-show-meridian="false" data-minute-step="5" data-second-step="5" />
												</div>
											</div>
										</div>
									</div>
									<div class="col-md-6">
										<div class="form-group">
											<label class="col-sm-3 control-label">Fin</label>
											<div class="col-sm-12" style="padding: 0px 0px !important; margin-bottom:15px">
												<div class="date-and-time">
													<input type="text" id="eventEndDate" name="eventEndDate" class="form-control datepicker" data-format="dd/mm/yyyy">
													<input type="text" id="eventEndTime" name="eventEndTime" class="form-control timepicker" data-template="dropdown" data-show-seconds="false" data-default-time="23:00" data-show-meridian="false" data-minute-step="5" data-second-step="5" />
												</div>
											</div>
										</div>
									</div>
							</div>
							<div class="row">
									<div class="col-md-12">
										<textarea style="margin: 0px; height: 200px; width: 100%;" id="eventDescription" name="eventDescription"></textarea>
									</div>
							</div>

						</form>
					</div>
					</br></br>
					</div>
					<div id="calendar-modal-new-event-footer" class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
						<button attr-id="" attr-action="" id="calendar-modal-new-event-button-continue" type="button" class="btn btn-red">Guardar</button>
					</div>
				</div>
			</div>
		</div>
	<!-- END MODALS -->
  {{ include('@Share/shareForm.twig') }}

{% block footer %}

	<link rel="stylesheet" href="{{ url('index') }}js/datatables/datatables.css">
	<link rel="stylesheet" href="{{ url('index') }}js/select2/select2-bootstrap.css">
	<link rel="stylesheet" href="{{ url('index') }}js/select2/select2.css">
  <link rel="stylesheet" href="{{ url('index') }}js/fullcalendar-2/fullcalendar.min.css">
	<link rel="stylesheet" href="{{ url('index') }}css/colpick.css">
	<link rel="stylesheet" href="{{ url('index') }}js/selectboxit/jquery.selectBoxIt.css">

	<!-- Imported scripts on this page -->
 	<script src="{{ url('index') }}js/datatables/datatables.js"></script>
	<script src="{{ url('index') }}js/select2/select2.min.js"></script>
	<script src="{{ url('index') }}js/moment.min.js"></script>
	<script src="{{ url('index') }}js/moment-es.js"></script>

  <script src="{{ url('index') }}js/fullcalendar-2/fullcalendar.min.js"></script>
	<script src='{{ url('index') }}js/fullcalendar-2/lang/es.js'></script>
	<script src="{{ url('index') }}js/bootstrap-colorpicker.min.js" type="text/javascript"></script>
	<script src="{{ url('index') }}js/colpick.js" type="text/javascript"></script>
	<script src="{{ url('index') }}js/bootstrap-datepicker.js"></script>
	<script src="{{ url('index') }}js/bootstrap-timepicker.min.js"></script>


 	<script src="https://cloud.tinymce.com/stable/tinymce.min.js?apiKey=qexr99c3p9zt8fk36ffsc5treo2qnx5vs791143vsty03xjx"></script>

  <script>
  var fullCalendar = fullCalendar || {};

  ;(function($, window, undefined)
  {
    "use strict";

    $(document).ready(function(){
			var load_wait=0;
      fullCalendar.$container = $(".calendar-env");
      $.extend(fullCalendar, {
        isPresent: fullCalendar.$container.length > 0
      });

      //Container Height fit with the document
      if(fullCalendar.isPresent){
        fullCalendar.$sidebar = fullCalendar.$container.find('.calendar-sidebar');
        fullCalendar.$body = fullCalendar.$container.find('.calendar-body');

        // Checkboxes
        var $cb = fullCalendar.$body.find('table thead input[type="checkbox"], table tfoot input[type="checkbox"]');
        $cb.on('click', function(){
          $cb.attr('checked', this.checked).trigger('change');
          calendar_toggle_checkbox_status(this.checked);
        });
        // Highlight
        fullCalendar.$body.find('table tbody input[type="checkbox"]').on('change', function(){
          $(this).closest('tr')[this.checked ? 'addClass' : 'removeClass']('highlight');
        });

        // Setup Calendar
        if($.isFunction($.fn.fullCalendar)){
          var calendar = $('#calendar');
          calendar.fullCalendar({
						eventSources: [],
            header: {
              left: 'title',
              right: 'month,agendaWeek,agendaDay today prev,next'
            },
            //defaultView: 'basicWeek',
            editable: true,
            firstDay: 1,
            height: 600,
            droppable: true,
            drop: function(date, allDay) {
              var $this = $(this),
                eventObject = {
                  title: $this.text(),
                  start: date,
                  allDay: allDay,
                  className: $this.data('event-class')
                };
              calendar.fullCalendar('renderEvent', eventObject, true);
              $this.remove();
            },
						eventClick: function(calEvent, jsEvent, view) {
							event.preventDefault();
							if((++load_wait)==1) $("#load-spinner").fadeIn();
							$.get(calEvent.url,'', function( data ){
								console.log(data)
								$("#eventId").val(data.id);
								$("#eventTitle").val(data.title);
								$("#eventAllDay").val(data.allDay);
								$("#eventLocation").val(data.location);
								$("#eventCalendar").data("selectBox-selectBoxIt").selectOption(data.calendar+"");
							  $("#eventColor").colpickSetColor(data.color!=null?data.color:'');
							 	$("#eventColor").val(data.color!=null?data.color:'');
								$("#eventStartDate").val(data.startDate);
								$("#eventStartTime").val(data.startTime);
								$("#eventEndDate").val(data.endDate);
								$("#eventEndTime").val(data.endTime);
								tinymce.get('eventDescription').setContent(data.description);

							},'json').always(function() {
									if((--load_wait)==0) $("#load-spinner").fadeOut();
									$('#calendar-modal-new-event').modal('toggle');
							});
					  },
						loading: function( isLoading, view ) {
	            if(isLoading) {//
	               if((++load_wait)==1) $("#load-spinner").fadeIn();
	            } else {
	               if((--load_wait)==0) $("#load-spinner").fadeOut();
	            }
        		},
					  eventDrop:function( event, delta, revertFunc, jsEvent, ui, view ){
							console.log(event);
							var start=event.start.format();
							var end=(event.end!=null)?event.end.format():'';
							if((++load_wait)==1) $("#load-spinner").fadeIn();
							console.log(start);
							console.log(end);
							$.get('{{ url('eventChangeDate') }}','eventId='+event.id+'&eventStart='+start+((event.end!=null)?'&eventEnd='+end:''), function( data ){
								if(data.result){
										toastr.success("Evento guardado correctamente", "Confirmación", confirmation);
									}else toastr.error("No se pudo guardar el evento", "Confirmación", confirmation);
							},'json').always(function() {
									if((--load_wait)==0) $("#load-spinner").fadeOut();
							});
						},

						eventResize:function( event, delta, revertFunc, jsEvent, ui, view ) {
							console.log(event.end.format());
							var end=event.end.format();
							if((++load_wait)==1) $("#load-spinner").fadeIn();
							$.get('{{ url('eventChangeDate') }}','eventId='+event.id+'&eventEnd='+end, function( data ){
								if(data.result){
										toastr.success("Evento guardado correctamente", "Confirmación", confirmation);
									}else toastr.error("No se pudo guardar el evento", "Confirmación", confirmation);
							},'json').always(function() {
									if((--load_wait)==0) $("#load-spinner").fadeOut();
							});

						}

          });

          $("#draggable_events li a").draggable({
            zIndex: 999,
            revert: true,
            revertDuration: 0
          }).on('click', function(){
            return false;
          });
        }
        else{
          alert("Please include full-calendar script!");
        }

        $("body").on('submit', '#add_event_form', function(ev){
          fit_calendar_container_height();
          return false;
        });
      }


			//Calendars load
			function getCalendars(url, params){
				if((++load_wait)==1) $("#load-spinner").fadeIn();
					$("#list-messages").html('');
					$.getJSON(url+params, function( data ) {
						$("#calendar-list").html('<li><p>Mis Calendarios</p></li>');
						$.each( data, function( key, val ) {
							 $("#eventCalendar").data("selectBox-selectBoxIt").add({ value: val.id, text: val.name});
							 $("#calendar-list").append('<li style="display: block"><a attr-url="'+val.url+'" id="calendar-list-'+val.id+'" style="width: 60%; display: inline-block; background: '+val.color+' !important;" href="javascript:;">'+
 																				 '<div class="display: inline-block; checkbox checkbox-replace color-white">'+
 																				 '<input type="checkbox" attr-eventUrl="'+val.eventUrl+'" attr-id="" class="'+val.id+'-chk-list" id="chk-calendar-'+val.id+'"'+((val.active)?' checked':'')+'>'+
 																				 '<label>'+val.name+'</label></div></a><div class="btn-group" style="display: inline-block; vertical-align: top;"><button attr-url="'+val.url+'" class="btn" id="calendar-list-edit-'+val.id+'" style="padding: 8px 12px;"><i class="fa fa-ellipsis-v"></i></button>'+
																				 '<button class="btn" id="calendar-list-remove-'+val.id+'" style="padding: 8px 8px;"><i class="fa fa-remove" style="color: #e26a6a;"></i></button></div></li>');
						});

						replaceCheckboxes();
					}).always(function() {
						if((--load_wait)==0) $("#load-spinner").fadeOut();
					});
			}

			//Calendar Enable/Disable
			$('body').on('change', "[id^='chk-calendar-']", function() {
			    if(this.checked) {
			        $('#calendar').fullCalendar('addEventSource', $(this).attr("attr-eventUrl"));
			    }else{
							$('#calendar').fullCalendar('removeEventSource', $(this).attr("attr-eventUrl"));
					}
			});

			//Color picker
			$('#calendar-modal-new-calendar').on('shown.bs.modal', function() {
				$('#calendarColor').colpick({
            colorScheme:'dark',
            onChange:function(hsb,hex,rgb,el,bySetColor) {
                $(el).val('#'+hex);
            },
						onSubmit:function(hsb,hex,rgb,el,bySetColor) {
							 $(el).colpickHide();
					 }
        });
			});
			$('#calendar-modal-new-event').on('shown.bs.modal', function() {
				$('#eventColor').colpick({
            colorScheme:'dark',
            onChange:function(hsb,hex,rgb,el,bySetColor) {
                $(el).val('#'+hex);
            },
						onSubmit:function(hsb,hex,rgb,el,bySetColor) {
							 $(el).colpickHide();
					 }
        });
			});

			$('#calendar-modal-new-event').on('shown.bs.modal', function() {
				replaceCheckboxes();
			});

			//New Calendar button
			$('body').on('click', "#calendar-modal-new-calendar-button-continue", function() {
				$('#calendar-modal-new-calendar').modal('toggle');
				if((++load_wait)==1) $("#load-spinner").fadeIn();
				$.get('{{ url('calendarSave') }}',$("#calendar-modal-new-calendar-form").serialize(), function( data ){
					if(data.result){
							getCalendars('{{url('calendarsList')}}', '');
							toastr.success("Calendario guardado correctamente", "Confirmación", confirmation);
						}else toastr.error("No se pudo guardar el calendario", "Confirmación", confirmation);
				},'json').always(function() {
						if((--load_wait)==0) $("#load-spinner").fadeOut();
				});
			});
			//Edit Calendar
			$('body').on('click', "[id^='calendar-list-edit-']", function() {
				$.get($(this).attr("attr-url"),'', function( data ){
					$("#calendarId").val(data.id);
					$("#calendarName").val(data.name);
					$("#calendarColor").colpickSetColor(data.color);
				},'json').always(function() {
						if((--load_wait)==0) $("#load-spinner").fadeOut();
						$('#calendar-modal-new-calendar').modal('toggle');
				});
			});


			//Save Event button
			$('body').on('click', "#calendar-modal-new-event-button-continue", function() {
				$('#calendar-modal-new-event').modal('toggle');
				if((++load_wait)==1) $("#load-spinner").fadeIn();
				$.get('{{ url('eventSave') }}',$("#calendar-modal-new-event-form").serialize()+"&description="+encodeURIComponent(tinymce.get('eventDescription').getBody().textContent), function( data ){
					if(data.result){
							$('#calendar').fullCalendar('refetchEvents');
							toastr.success("Evento guardado correctamente", "Confirmación", confirmation);
						}else toastr.error("No se pudo guardar el evento", "Confirmación", confirmation);
				},'json').always(function() {
						if((--load_wait)==0) $("#load-spinner").fadeOut();
				});
			});

			//Event description
			var wysihtml5Editor = tinymce.init({
				selector: '#eventDescription',
				branding: false,
				height: 225,
				theme: 'modern',
				menubar:false,
    		statusbar: false,
				/*plugins: 'print preview fullpage powerpaste searchreplace autolink directionality advcode visualblocks visualchars fullscreen image link media template codesample table charmap hr pagebreak nonbreaking anchor toc insertdatetime advlist lists textcolor wordcount tinymcespellchecker a11ychecker imagetools mediaembed  linkchecker contextmenu colorpicker textpattern help',*/
				toolbar1: 'formatselect | bold italic strikethrough forecolor backcolor | link | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent  | removeformat',
				language_url : '/js/tiny_mce/langs/es.js',  // site absolute URL
				image_advtab: false,
				setup: function (editor) {
					/*editor.on('init', function (e) {
						getSignature();
						editor_init=true;
					});*/
				},
				content_css: [
					'//fonts.googleapis.com/css?family=Lato:300,300i,400,400i',
					'//www.tinymce.com/css/codepen.min.css'
				]
			 });

			//Initial Load
			getCalendars('{{url('calendarsList')}}', '');


		});
  })(jQuery);

  function fit_calendar_container_height(){
    if(fullCalendar.isPresent){
      if(fullCalendar.$sidebar.height() < fullCalendar.$body.height()){
        fullCalendar.$sidebar.height( fullCalendar.$body.height() );
      }else{
        var old_height = fullCalendar.$sidebar.height();
        fullCalendar.$sidebar.height('');
        if(fullCalendar.$sidebar.height() < fullCalendar.$body.height()){
          fullCalendar.$sidebar.height(old_height);
        }
      }
    }
  }

  function reset_calendar_container_height(){
    if(fullCalendar.isPresent){
      fullCalendar.$sidebar.height('auto');
    }
  }

  function calendar_toggle_checkbox_status(checked){
    fullCalendar.$body.find('table tbody input[type="checkbox"]' + (checked ? '' : ':checked')).attr('checked',  ! checked).click();
  }

  </script>
  {{ include('@Globale/bottom.html.twig') }}
	<script src="{{ url('index') }}js/selectboxit/jquery.selectBoxIt.min.js"></script>
	<script src="{{ url('index') }}js/typeahead.min.js"></script>
{% endblock %}
</body>
