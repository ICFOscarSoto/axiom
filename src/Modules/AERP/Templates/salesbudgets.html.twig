{% set params = app.request.attributes.get('_route_params')|merge(app.request.query.all()) %}
{% block header %}
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="description" content="Neon Admin Panel" />
	<meta name="author" content="" />
	{{ include('@Globale/header.html.twig') }}
	<!-- Imported styles on this page -->
	<link rel="stylesheet" href="{{ url('index') }}css/bootstrap-grid.css">
	<link rel="stylesheet" href="{{ url('index') }}/js/jvectormap/jquery-jvectormap-1.2.2.css">
	<link rel="stylesheet" href="{{ url('index') }}/js/rickshaw/rickshaw.min.css">
{% endblock %}
<title>{% block title %}{{ interfaceName|trans }}{% endblock %}</title>
<body class="page-body" data-url="{{ url('indexAdmin') }}">
<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
	{{ include('@Globale/sidebar_menu.html.twig') }}
	<div class="main-content">
		{{ include('@Globale/head.html.twig') }}
		<hr />
		{{ include('@Globale/breadcrumb.html.twig') }}
		{#}<h2>{{ interfaceName }}</h2>#}
		<!-- MAIN CONTENT -->
		<div class="row">
				<div style="text-align: left;" class="col-md-8">
					<div id="document-action-buttons">
						<button id="document-button-print" type="button" class="btn btn">Imprimir</button>
						<button id="document-button-makeorder" type="button" class="btn btn">A Pedido</button>
					</div>
				</div>
		    <div style="text-align: right;" class="col-md-4">
		      <button attr-id="" attr-action="" id="document-button-cancel" type="button" class="btn btn">Cancelar</button>
		      <button attr-id="" attr-action="" id="document-button-save" type="button" class="btn btn-green">Guardar</button>
		    </div>
		</div>
		<br/>
			<div class="panel panel-primary panel-shadow" data-collapsed="0" style="-webkit-box-shadow: none; box-shadow:none; padding:0px; margin-bottom: -1px;"><!-- to apply shadow add class "panel-shadow" -->
				<div class="panel-body">
					<div class="row">
						<div class="col-md-2">
							<div class="input-group">
								<input type="text" id="customer-form-code" value="{% if document.customer!=null %}{{ document.customer.code }}{% endif %}" class="form-control" placeholder="Cod. Cliente">
									<div class="input-group-btn">
										<button type="button" id="customer-search-button" class="btn btn-white" style="height: 31px;" data-toggle="modal" data-target="#customer-search-modal-form">
											 	<i class="fa fa-search"></i> </button>
									</div>
							</div>
						</div>
						<input type="hidden" id="customer-form-id" class="form-control" value="{% if document.customer!=null %}{{ document.customer.id }}{% endif %}">
						<input type="hidden" id="customer-form-irpf" value="{% if id!=0 %}{% if document.irpf %}true{% else %}false{% endif %}{% else %}{{ moduleConfig.irpf ? 'true' : 'false' }}{% endif %}" class="form-control">
						<input type="hidden" id="customer-form-irpf-perc" value="{% if id!=0 %}{% if document.irpfperc %}true{% else %}false{% endif %}{% else %}{{ moduleConfig.defaultirpf }}{% endif %}" class="form-control">
						<input type="hidden" id="customer-form-taxexempt" value="{% if document.taxexempt %}true{% else %}false{% endif %}" class="form-control">
						<input type="hidden" id="customer-form-surcharge" value="{% if document.surcharge %}true{% else %}false{% endif %}" class="form-control">
						<div class="col-md-6"> <div class="form-group">
							<span id="customer-form-view" class="select2-selection__view_nolabel" style="" attr-id=0 attr-url="{{ url('formAERPCustomer',{'id':'_____'}) }}"><i class="fa fa-file-text-o" aria-hidden="true"></i><span>&nbsp;Ver Ficha</span></span>
							<script>
							$('body').on('click', "#customer-form-view", function(e){
								var id=$(this).attr("attr-id");
									if(id!=0 && id!=""){
										url=$(this).attr("attr-url");
										url=url.replace('_____',$(this).attr("attr-id"));
										var win = window.open(url, '_blank');
										win.focus();
									}
							});
							</script>
							<input type="text" id="customer-form-name" class="form-control" placeholder="Nombre cliente" value="{{ document.customername }}" disabled> </div> </div>
						<div class="col-6 col-md-2"> <div class="form-group"> <input type="text" id="customer-form-vat" value="{{ document.vat }}" class="form-control" placeholder="CIF" disabled> </div> </div>
						<div class="col-6 col-md-2"> <div class="form-group">
						<input type="hidden" id="customer-form-customergroup" value="" class="form-control">
						<select type="text" id="customer-form-customergroup-select"  class="form-control select2">
							{% for option in customerGroups %}
								<option value="{{ option.id }}" {% if document.customergroup!=null and option.id==document.customergroup.id %} selected="selected" {% endif %}>{{ option.text }}</option>
							{% endfor %}
						</select>
						</div> </div>
					</div>
				</div>
			</div>

			<div class="panel panel-primary panel-shadow" data-collapsed="0" style="-webkit-box-shadow: none; box-shadow:none; padding:0px; margin-bottom: -1px;"><!-- to apply shadow add class "panel-shadow" -->
				<div class="panel-body">
					<div class="row">
						<div class="col-6 col-sm-2"> <div class="input-group"> <span class="input-group-addon"><i class="fa fa-hashtag"></i></span><input type="hidden" id="document-form-id" value="{{ document.id }}" class="form-control"><input type="text" id="document-form-code" value="{{ document.code }}" class="form-control" placeholder="N. Documento" disabled> </div></div>
						<div class="col-6 col-sm-2"> <div class="input-group"> <span class="input-group-addon"><i class="fa fa-calendar"></i></span> <input type="text" id="document-form-date" class="form-control datepicker" style="z-index:99 !important;" placeholder="Fecha" value="{{ date }}"></div></div>
						<div class="col-6 col-sm-2"> <div class="input-group"> <span class="input-group-addon"><i class="fa fa-calendar"></i></span> <input type="text" id="document-form-dateofferend" class="form-control datepicker" style="z-index:99 !important;" placeholder="Fin oferta" value="{{ enddate }}"></div></div>
						<div class="col-6 col-sm-2"> <div class="input-group"> <span class="input-group-addon"><i class="fa fa-hashtag"></i></span> <input type="text" id="document-form-customercode" class="form-control" placeholder="Su referencia" value="{{ document.customercode }}"> </div> </div>
						<div class="col-6 col-sm-2"> <div class="form-group">
							<select type="text"  id="document-form-series-select" class="form-control select2">
								{% for option in series %}
									<option value="{{ option.id }}"{% if document.serie!=null and option.id==document.serie.id %} selected="selected" {% endif %}>{{ option.text }}</option>
								{% endfor %}
							</select>
						</div> </div>
						<div class="col-6 col-sm-2"> <div class="form-group">
							<input type="hidden" id="customer-form-paymentmethod" class="form-control">
							<select type="text" id="customer-form-paymentmethod-select" class="form-control select2">
								{% for option in paymentMethods %}
									<option value="{{ option.id }}"{% if id!=0 %}{% if document.paymentmethod!=null and option.id==document.paymentmethod.id %} selected="selected" {% endif %}{% else %}{% if option.id==moduleConfig.defaultpaymentmethod.id %} selected="selected" {% endif %}{% endif %}>{{ option.text }}</option>
								{% endfor %}
							</select>
						</div> </div>

					</div>
				</div>
			</div>

			<div class="panel panel-primary panel-shadow" data-collapsed="0" style="-webkit-box-shadow: none; box-shadow:none;min-height:200px"><!-- to apply shadow add class "panel-shadow" -->
				<div class="panel-body" style="padding: 0px !important;" id="document-lines" attr-numlines="{{ documentLines|length }}">

					<div class="row no-gutters documents-products-header">
						<div class="col-sm-2 d-none d-sm-block">Cod. Producto</div>
						<div class="col-sm-3 d-none d-sm-block">Descripci√≥n</div>
						<div class="col-sm-1 d-none d-sm-block">Precio</div>
						<div class="col-sm-1 d-none d-sm-block">Cantidad</div>
						<div class="col-sm-1 d-none d-sm-block">Dto.</div>
						<div class="col-sm-1 d-none d-sm-block">IVA</div>
						<div class="col-sm-1 d-none d-sm-block">R.E.</div>
						<div class="col-sm-2 d-none d-sm-block">Subtotal</div>
					</div>

					{% for line in  documentLines %}
						<div class="row no-gutters" attr-id="{{ line.linenum }}" id="document-line-{{ line.linenum }}">
							<div class="col-2 d-block d-sm-none" style="top: 8px;">Cod. Prod.</div>
							<div class="col-10 col-sm-2">
								<div class="form-group" style="margin-bottom: 0px;">
									<div class="input-group" >
										<a class="btn btn-white" attr-id="{{ line.linenum }}" id="product-form-remove-{{ line.linenum }}" style="position: absolute;height: 31px;left: 0px;padding: 9px 7px;z-index: 10;" href="#"> <i class="fa fa-remove"></i></a>
										<input type="hidden" attr-id="{{ line.linenum }}" id="product-form-line-id-{{ line.linenum }}" value={% if line!=null %}{{ line.id }}{% endif %}><input type="hidden" attr-id="{{ line.linenum }}" id="product-form-id-{{ line.linenum }}" value={% if line.product!=null %}{{ line.product.id }}{% endif %}><input type="text" attr-id="{{ line.linenum }}" id="product-form-code-{{ line.linenum }}" class="form-control" style="padding-left: 28px; border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="Cod. Producto" value="{{ line.code }}">
										<div class="input-group-btn"><button type="button" attr-id="{{ line.linenum }}" id="product-search-button-{{ line.linenum }}" class="btn btn-white" style="height: 31px; border-radius: 0px;"><i class="fa fa-search"></i> </button></div>
									</div>
								</div>
							</div>
							<div class="col-2 d-block d-sm-none" style="top: 8px;">Nombre</div>
							<div class="col-10 col-sm-3"> <div class="form-group" style="margin-bottom: 0px;"> <input type="text" id="product-form-name-{{ line.linenum }}" class="form-control" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="Nombre" value="{{ line.name }}"> </div> </div>
							<div class="col-2 d-block d-sm-none" style="top: 8px;">Precio</div>
							<div class="col-4 col-sm-1"> <div class="form-group" style="margin-bottom: 0px;"> <span class="input__unity_nolabel "><span>‚Ç¨</span></span><input type="text" attr-id="{{ line.linenum }}" id="product-form-price-{{ line.linenum }}" class="recalculate form-control number-type input_parent__unity" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="Precio" value={{ line.unitprice }}> </div> </div>
							<div class="col-2 d-block d-sm-none" style="top: 8px;left: 5px;">Cantidad</div>
							<div class="col-4 col-sm-1"> <div class="form-group" style="margin-bottom: 0px;"> <input type="hidden" attr-id="{{ line.linenum }}" value={{ line.unitprice * line.quantity }} id="product-form-base-total-{{ line.linenum }}"><input type="text" attr-id="{{ line.linenum }}" id="product-form-quantity-{{ line.linenum }}" class="recalculate form-control number-type" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="Cantidad" value={{ line.quantity }}> </div> </div>
							<div class="col-2 d-block d-sm-none" style="top: 8px;">Dto.</div>
							<div class="col-4 col-sm-1"> <div class="form-group" style="margin-bottom: 0px;"> <span class="input__unity_nolabel "><span>%</span></span><input type="hidden" attr-id="{{ line.linenum }}" id="product-form-disccount-total-{{ line.linenum }}" value={{ line.dtounit }}><input type="text" attr-id="{{ line.linenum }}" id="product-form-disccount-{{ line.linenum }}" class="recalculate form-control number-type input_parent__unity" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="Dto" value={{ line.dtoperc }}> </div> </div>
							<div class="col-2 d-block d-sm-none" style="top: 8px;left: 5px;">IVA</div>
							<div class="col-4 col-sm-1"> <div class="form-group" style="margin-bottom: 0px;"> <span class="input__unity_nolabel "><span>%</span></span><input type="hidden" attr-id="{{ line.linenum }}" id="product-form-irpf-total-{{ line.linenum }}" value={{ line.irpfunit }}><input type="hidden" attr-id="{{ line.linenum }}" id="product-form-tax-total-{{ line.linenum }}" value={{ line.taxunit }}><input type="text" attr-id="{{ line.linenum }}" id="product-form-tax-{{ line.linenum }}" class="recalculate form-control number-type input_parent__unity" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="IVA" value={{ line.taxperc }}> </div> </div>
							<div class="col-2 d-block d-sm-none" style="top: 8px;">R.E.</div>
							<div class="col-4 col-sm-1"> <div class="form-group" style="margin-bottom: 0px;"> <span class="input__unity_nolabel "><span>%</span></span><input type="hidden" attr-id="{{ line.linenum }}" value=0  id="product-form-surcharge-perc-{{ line.linenum }}"><input type="hidden" attr-id="{{ line.linenum }}" id="product-form-surcharge-total-{{ line.linenum }}" value={{ line.surchargeunit }}><input type="text" attr-id="{{ line.linenum }}" id="product-form-surcharge-{{ line.linenum }}" class="recalculate form-control number-type input_parent__unity" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="Recargo" value={{ line.surchargeperc }}> </div> </div>
							<div class="col-2 d-block d-sm-none" style="top: 8px;left: 5px;">Subtotal</div>
							<div class="col-4 col-sm-2"> <div class="form-group" style="margin-bottom: 0px;"> <span class="input__unity_nolabel "><span>‚Ç¨</span></span><input type="text" attr-id="{{ line.linenum }}" id="product-form-amount-{{ line.linenum }}" class="form-control number-type input_parent__unity" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="TOTAL" disabled value={{ line.total }}></div> </div>
						</div>
					{% endfor %}

				</div>
			</div>
			<div class="panel panel-primary panel-shadow" data-collapsed="0" style="-webkit-box-shadow: none; box-shadow:none;"><!-- to apply shadow add class "panel-shadow" -->
				<div class="panel-body" style="padding: 0px !important;" id="document-totals" attr-numlines="1">
					<div class="row">
						<div class="col-4 col-sm-2">
							<div class="form-group">
								<label for="totals_form_net">Importe</label>
								<span id="unity-view-formProducts-price" class="input__unity"><span>‚Ç¨</span></span>
								<input type="text" id="totals_form_net" maxlength="150" class="number-type input_parent__unity form-control" value={{ document.totalnet }} disabled>
							</div>
						</div>
						<div class="col-4 col-sm-2">
							<div class="form-group">
								<label for="totals_form_dto">Descuento</label>
								<span id="unity-view-formProducts-price" class="input__unity"><span>‚Ç¨</span></span>
								<input type="text" id="totals_form_dto" maxlength="150" class="number-type input_parent__unity form-control" value={{ document.totaldto }} disabled>
							</div>
						</div>
						<div class="col-4 col-sm-2">
							<div class="form-group">
								<label for="totals_form_tax">Total IVA</label>
								<span id="unity-view-formProducts-price" class="input__unity"><span>‚Ç¨</span></span>
								<input type="text" id="totals_form_tax" maxlength="150" class="number-type input_parent__unity form-control" value={{ document.totaltax }} disabled>
							</div>
						</div>
						<div class="col-4 col-sm-2">
							<div class="form-group">
								<label for="totals_form_surcharge">Total R.E.</label>
								<span id="unity-view-formProducts-price" class="input__unity"><span>‚Ç¨</span></span>
								<input type="text" id="totals_form_surcharge" maxlength="150" class="number-type input_parent__unity form-control" value={{ document.totalsurcharge }} disabled>
							</div>
						</div>
						<div class="col-4 col-sm-2">
							<div class="form-group">
								<label for="totals_form_irpf">IRPF</label>
								<span id="unity-view-formProducts-price" class="input__unity"><span>‚Ç¨</span></span>
								<input type="text" id="totals_form_irpf" maxlength="150" class="number-type input_parent__unity form-control" value={{ document.totalirpf }} disabled>
							</div>
						</div>
						<div class="col-4 col-sm-2">
							<div class="form-group">
								<label for="totals_form_total">TOTAL</label>
								<span id="unity-view-formProducts-price" class="input__unity"><span>‚Ç¨</span></span>
								<input type="text" id="totals_form_total" maxlength="150" class="number-type input_parent__unity form-control" value={{ document.total }} disabled>
							</div>
						</div>

					</div>
				</div>
			</div>

		<!-- MODALS  -->
		{% if forms is defined %}
			{% for form in forms %}
			  {% set formConstructor = form %}
				{{ include('@Globale/genericajaxform.html.twig') }}
			{% endfor %}
		{% endif %}


		<div class="modal fade" tabindex="-1" id="customer-search-modal-form" aria-hidden="true">
				<div class="modal-dialog modal-lg">
					<div class="modal-content" style="transform: matrix(1, 0, 0, 1, 0, 0);">
						<div class="modal-header">
							<h4 class="modal-title">{{ ('Search')|trans }}&nbsp;{{ ('customer')|trans }}</h4>
						</div>
		        <div id="customer-search-modal-form-body" style="height: 520px; padding: 0px 10px;">
							{% set listConstructor = customerslist %}
							{% set listOrigin = "" %}
							{# for know if list.html is invoked directly from controller and we need to make modals inside list#}
							{{ include('@Globale/list.html.twig') }}
		        </div>
				</div>
			</div>
		</div>

		<div class="modal fade" tabindex="-1" id="product-search-modal-form" aria-hidden="true">
				<div class="modal-dialog modal-lg">
					<div class="modal-content" style="transform: matrix(1, 0, 0, 1, 0, 0);">
						<div class="modal-header">
							<h4 class="modal-title">{{ ('Search')|trans }}&nbsp;{{ ('productos')|trans }}</h4>
						</div>
						<div id="product-search-modal-form-body" style="height: 520px; padding: 0px 10px;">
							{% set listConstructor = productslist %}
							{% set listOrigin = "" %}
							{# for know if list.html is invoked directly from controller and we need to make modals inside list#}
							{{ include('@Globale/list.html.twig') }}
						</div>
				</div>
			</div>
		</div>
		{{ include("@Globale/form_fields_type_number.html.twig") }}
		<script>


			function addDocumentLine(){
				var documentLines=$("#document-lines");
				var numLines=parseInt(documentLines.attr("attr-numlines"))+1;
				documentLines.append(''+
				'<div class="row no-gutters" attr-id="'+numLines+'" id="document-line-'+numLines+'">'+
				'<div class="col-12 d-block d-sm-none" style="height: 15px;">&nbsp;</div>'+
				'<div class="col-2 d-block d-sm-none" style="top: 8px;">Cod. Prod.</div>'+
				'	<div class="col-10 col-md-2">'+
				'		<div class="form-group" style="margin-bottom: 0px;">'+
				'			<div class="input-group" >'+
				'				<a class="btn btn-white" attr-id="'+numLines+'" id="product-form-remove-'+numLines+'" style="position: absolute;height: 31px;left: 0px;padding: 9px 7px;z-index: 10;" href="#"> <i class="fa fa-remove"></i></a>'+
				'				<input type="hidden" attr-id="'+numLines+'" id="product-form-line-id-'+numLines+'"><input type="hidden" attr-id="'+numLines+'" id="product-form-id-'+numLines+'"><input type="text" attr-id="'+numLines+'" id="product-form-code-'+numLines+'" class="form-control" style="padding-left: 28px; border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="Cod. Producto">'+
				'				<div class="input-group-btn"><button type="button" attr-id="'+numLines+'" id="product-search-button-'+numLines+'" class="btn btn-white" style="height: 31px; border-radius: 0px;"><i class="fa fa-search"></i> </button></div>'+
				'			</div>'+
				'		</div>'+
				'	</div>'+
				' <div class="col-2 d-block d-sm-none" style="top: 8px;">Nombre</div>'+
				'	<div class="col-10 col-md-3"> <div class="form-group" style="margin-bottom: 0px;"> <input type="text" id="product-form-name-'+numLines+'" class="form-control" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="Nombre"> </div> </div>'+
				' <div class="col-2 d-block d-sm-none" style="top: 8px;">Precio</div>'+
				'	<div class="col-4 col-md-1"> <div class="form-group" style="margin-bottom: 0px;"> <span id="unity-view-formProducts-price" class="input__unity_nolabel "><span>‚Ç¨</span></span><input type="text" attr-id="'+numLines+'" id="product-form-price-'+numLines+'" class="recalculate form-control number-type input_parent__unity" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="Precio"> </div> </div>'+
				' <div class="col-2 d-block d-sm-none" style="top: 8px;left: 5px;">Cantidad</div>'+
				'	<div class="col-4 col-md-1"> <div class="form-group" style="margin-bottom: 0px;"> <input type="hidden" attr-id="1" value=0 id="product-form-base-total-'+numLines+'"><input type="text" attr-id="'+numLines+'" value=1 id="product-form-quantity-'+numLines+'" class="recalculate form-control number-type" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="Cantidad"> </div> </div>'+
				' <div class="col-2 d-block d-sm-none" style="top: 8px;">Dto.</div>'+
				'	<div class="col-4 col-md-1"> <div class="form-group" style="margin-bottom: 0px;"> <span id="unity-view-formProducts-price" class="input__unity_nolabel "><span>%</span></span><input type="hidden" attr-id="1" value=0 id="product-form-disccount-total-'+numLines+'"><input type="text" attr-id="'+numLines+'" id="product-form-disccount-'+numLines+'" value=0 class="recalculate form-control number-type input_parent__unity" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="Dto"> </div> </div>'+
				' <div class="col-2 d-block d-sm-none" style="top: 8px;left: 5px;">IVA</div>'+
				'	<div class="col-4 col-md-1"> <div class="form-group" style="margin-bottom: 0px;"> <span id="unity-view-formProducts-price" class="input__unity_nolabel "><span>%</span></span><input type="hidden" attr-id="1" value=0 id="product-form-irpf-total-'+numLines+'"><input type="hidden" attr-id="1" value=0 id="product-form-tax-total-'+numLines+'"><input type="text" attr-id="'+numLines+'" id="product-form-tax-'+numLines+'" value=21 class="recalculate form-control number-type input_parent__unity" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="IVA"> </div> </div>'+
				' <div class="col-2 d-block d-sm-none" style="top: 8px;">R.E.</div>'+
				'	<div class="col-4 col-md-1"> <div class="form-group" style="margin-bottom: 0px;"> <span id="unity-view-formProducts-price" class="input__unity_nolabel "><span>%</span></span><input type="hidden" attr-id="1" value=0  id="product-form-surcharge-perc-'+numLines+'"><input type="hidden" attr-id="1" value=0  id="product-form-surcharge-total-'+numLines+'"><input type="text" attr-id="'+numLines+'" id="product-form-surcharge-'+numLines+'" value=0 class="recalculate form-control number-type input_parent__unity" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="Recargo"> </div> </div>'+
				' <div class="col-2 d-block d-sm-none" style="top: 8px;left: 5px;">Subtotal</div>'+
				'	<div class="col-4 col-md-2"> <div class="form-group" style="margin-bottom: 0px;"> <span id="unity-view-formProducts-price" class="input__unity_nolabel "><span>‚Ç¨</span></span><input type="text" attr-id="'+numLines+'" id="product-form-amount-'+numLines+'" value=0 class="form-control number-type input_parent__unity" style="border: 1px solid #ebebeb !important; border-radius: 0px;" placeholder="TOTAL" disabled> </div> </div>'+
				'</div>');
				documentLines.attr("attr-numlines", numLines);
			}

			function removeDocumentLine(numLine){
				var documentLines=$("#document-lines");
				var numLines=parseInt(documentLines.attr("attr-numlines"));
				if(numLines!=numLine){
					 //$("#document-line-"+numLine).remove();
					 $("#document-line-"+numLine).addClass("deleted");
					 $("#product-form-base-total-"+numLine).addClass("deleted");
					 $("#product-form-disccount-total-"+numLine).addClass("deleted");
					 $("#product-form-tax-total-"+numLine).addClass("deleted");
					 $("#product-form-irpf-total-"+numLine).addClass("deleted");
					 $("#product-form-surcharge-total-"+numLine).addClass("deleted");
					 $("#product-form-amount-"+numLine).addClass("deleted");

					 $("#document-line-"+numLine).fadeOut();
					 $("#document-line-"+numLine).attr("id","document-line-3-deleted");
					 //documentLines.attr("attr-numlines",numLines);
					 numerateLines();
					 recalculateDocument();
				}
			}

			function recalculateDocument(){
				var i=0;
				var documentLines=$("#document-lines");
				$("[id^='document-line-']:not('.deleted')").each(function() {
					productSearch($(this).attr("attr-id"), $("#product-form-code-"+$(this).attr("attr-id")).val(), productFields, productSearchfields);
				});
			}

			function numerateLines(){
				var i=0;
				var documentLines=$("#document-lines");
				$("[id^='document-line-']:not(.deleted)").each(function() {
						i++;
						$(this).find("#product-form-id-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-line-id-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-line-id-"+$(this).attr("attr-id")).attr("id","product-form-line-id-"+i);
						$(this).find("#product-form-id-"+$(this).attr("attr-id")).attr("id","product-form-id-"+i);
						$(this).find("#product-form-code-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-code-"+$(this).attr("attr-id")).attr("id","product-form-code-"+i);
						$(this).find("#product-form-name-"+$(this).attr("attr-id")).attr("id","product-form-name-"+i);
						$(this).find("#product-search-button-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-search-button-"+$(this).attr("attr-id")).attr("id","product-search-button-"+i);
						$(this).find("#product-form-price-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-price-"+$(this).attr("attr-id")).attr("id","product-form-price-"+i);
						$(this).find("#product-form-quantity-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-quantity-"+$(this).attr("attr-id")).attr("id","product-form-quantity-"+i);
						$(this).find("#product-form-base-total-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-base-total-"+$(this).attr("attr-id")).attr("id","product-form-base-total-"+i);
						$(this).find("#product-form-disccount-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-disccount-"+$(this).attr("attr-id")).attr("id","product-form-disccount-"+i);
						$(this).find("#product-form-disccount-total-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-disccount-total-"+$(this).attr("attr-id")).attr("id","product-form-disccount-total-"+i);
						$(this).find("#product-form-tax-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-tax-"+$(this).attr("attr-id")).attr("id","product-form-tax-"+i);
						$(this).find("#product-form-tax-total-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-tax-total-"+$(this).attr("attr-id")).attr("id","product-form-tax-total-"+i);
						$(this).find("#product-form-irpf-total-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-irpf-total-"+$(this).attr("attr-id")).attr("id","product-form-irpf-total-"+i);
						$(this).find("#product-form-surcharge-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-surcharge-"+$(this).attr("attr-id")).attr("id","product-form-surcharge-"+i);
						$(this).find("#product-form-surcharge-perc-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-surcharge-perc-"+$(this).attr("attr-id")).attr("id","product-form-surcharge-perc-"+i);
						$(this).find("#product-form-surcharge-total-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-surcharge-total-"+$(this).attr("attr-id")).attr("id","product-form-surcharge-total-"+i);
						$(this).find("#product-form-amount-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-amount-"+$(this).attr("attr-id")).attr("id","product-form-amount-"+i);
						$(this).find("#product-form-remove-"+$(this).attr("attr-id")).attr("attr-id",i);
						$(this).find("#product-form-remove-"+$(this).attr("attr-id")).attr("id","product-form-remove-"+i);
						$(this).attr('attr-id',i);
						$(this).attr('id','document-line-'+i);
				});
				documentLines.attr("attr-numlines", i);
			}

			function calculateDocumentRow(id){
				var price=parseFloat($("#product-form-price-"+id).val());
				var quantity=parseFloat($("#product-form-quantity-"+id).val());
				var disccount=parseFloat($("#product-form-disccount-"+id).val());
				var tax=parseFloat($("#product-form-tax-"+id).val());
				var surcharge=parseFloat($("#product-form-surcharge-"+id).val());
				var irpf=parseFloat($("#product-form-irpf-"+id).val());
				var irpfperc=$("#customer-form-irpf-perc").val();
				price=(price=="")?0:price;
				tax=(tax=="")?0:tax;
				surcharge=(surcharge=="")?0:surcharge;
				price=isNaN(price)?0:price;
				quantity=isNaN(quantity)?0:quantity;
				disccount=isNaN(disccount)?0:disccount;
				tax=isNaN(tax)?0:tax;
				surcharge=isNaN(surcharge)?0:surcharge;
				var subtotal=price*quantity;
				$("#product-form-base-total-"+id).val(subtotal);
				var disccounttotal=subtotal*disccount/100;
				subtotal=(subtotal-disccounttotal).toFixed(2);
				var taxtotal=(subtotal*tax/100).toFixed(2);
				var irpftotal=(subtotal*irpfperc/100).toFixed(2);
				var surchargetotal=(subtotal*surcharge/100).toFixed(2);
				var total=parseFloat(subtotal)+parseFloat(taxtotal)+parseFloat(irpftotal)+parseFloat(surchargetotal);
				$("#product-form-disccount-total-"+id).val(disccounttotal);
				$("#product-form-tax-total-"+id).val(taxtotal);
				$("#product-form-irpf-total-"+id).val(irpftotal);
				$("#product-form-surcharge-total-"+id).val(surchargetotal);
				$("#product-form-amount-"+id).val(total.toFixed(2));
				calculateDocumentTotals();
			}

			function calculateDocumentTotals(){
				var base=0;
				var taxtotal=0;
				var irpftotal=0;
				var surchargetotal=0;
				var disccounttotal=0;
				var total=0;
				$("[id^='product-form-base-total-']:not('.deleted')").each(function() {	base+=parseFloat(isNaN($(this).val())?0:$(this).val()); });
				$("[id^='product-form-disccount-total-']:not('.deleted')").each(function() {	disccounttotal+=parseFloat(isNaN($(this).val())?0:$(this).val()); });
				$("[id^='product-form-tax-total-']:not('.deleted')").each(function() {	taxtotal+=parseFloat(isNaN($(this).val())?0:$(this).val()); });
				$("[id^='product-form-irpf-total-']:not('.deleted')").each(function() {	irpftotal+=parseFloat(isNaN($(this).val())?0:$(this).val()); });
				$("[id^='product-form-surcharge-total-']:not('.deleted')").each(function() {	surchargetotal+=parseFloat(isNaN($(this).val())?0:$(this).val()); });
				$("[id^='product-form-amount-']:not('.deleted')").each(function() {	total+=parseFloat(isNaN($(this).val())?0:$(this).val()); });
				$("#totals_form_net").val(base.toFixed(2));
				$("#totals_form_dto").val(disccounttotal.toFixed(2));
				$("#totals_form_tax").val(taxtotal.toFixed(2));
				$("#totals_form_irpf").val(irpftotal.toFixed(2));
				$("#totals_form_surcharge").val(surchargetotal.toFixed(2));
				$("#totals_form_total").val(total.toFixed(2));

			}

			var customerFields=["customer-form-id","customer-form-code","customer-form-vat","customer-form-name", "customer-form-customergroup", "customer-form-paymentmethod", "customer-form-taxexempt", "customer-form-surcharge"];
			var customerSearchfields=["id","code","vat","name", "customergroup", "paymentmethod", "taxexempt", "surcharge"];

			var productFields=["product-form-id","product-form-code","product-form-name","product-form-price","product-form-tax", "product-form-surcharge-perc"];
			var productSearchfields=["id","code","name","price","tax","surcharge"];

			function clearFields(fields){
				fields.forEach(function(element) {
					$("#"+element).val('');
				});
			}

			function postCustomerSearch(){
				$("#customer-form-customergroup-select").val($("#customer-form-customergroup").val());
				$("#customer-form-customergroup-select").select2().trigger('change');
				$("#customer-form-paymentmethod-select").val($("#customer-form-paymentmethod").val());
				$("#customer-form-paymentmethod-select").select2().trigger('change');
				$("#customer-form-view").attr("attr-id", $("#customer-form-id").val());
				recalculateDocument();
			}

			function customerSearch(fields, searchFields){
				if($("#customer-form-code").val()!=""){
					if((++load_wait)==1) $("#load-spinner").fadeIn();
		      $.ajax({
		         url: '{{ url('genericsearch',{'module':'AERP', 'name':'Customers', 'field':'code'}) }}/'+$("#customer-form-code").val(),
		         type: 'POST',
		         data: JSON.stringify(searchFields),
		         success:  function( data ) {
							 if((--load_wait)==0) $("#load-spinner").fadeOut();
		           if(data.result){
								 var i=0;
								 Object.entries(data.data).forEach(function(element) {
									 $("#"+fields[i]).val(element[1]);
									 i++;
								 });
								 postCustomerSearch();
		           } else {
								 clearFields(fields);
								 toastr.error("No se encontro el cliente introducido", "Confirmaci√≥n", confirmation);
							 }
		         }
		       });
			 	}else clearFields(fields);
			}

			function postProductSearch(id){
				if($("#customer-form-surcharge").val()=="true") $("#product-form-surcharge-"+id).val($("#product-form-surcharge-perc-"+id).val()); else $("#product-form-surcharge-"+id).val(0);
				calculateDocumentRow(id);
			}

			function productSearch(id, val, fields, searchFields){
				if(val!=""){
					if((++load_wait)==1) $("#load-spinner").fadeIn();
		      $.ajax({
		         url: '{{ url('productsearch',{'field':'code'}) }}/'+val+'/'+$("#customer-form-customergroup-select").val(),
		         type: 'POST',
		         data: JSON.stringify(searchFields),
		         success:  function( data ) {
							 if((--load_wait)==0) $("#load-spinner").fadeOut();
		           if(data.result){
								 var i=0;
								 Object.entries(data.data).forEach(function(element) {
									 $("#"+fields[i]+"-"+id).val(element[1]);
									 i++;
								 });
								 postProductSearch(id);
		           } else {
								 clearFields(fields);
								 //toastr.warning("No se encontro el producto introducido", "Confirmaci√≥n", confirmation);
							 }
		         }
		       });
				 }else clearFields(fields);
			}

			$(document).ready(function() {
					{{ include('@Globale/form_fields_datetime.html.twig') }}

					{# CUSTOMER SEARCH #}
					$('body').on('keypress', "#customer-form-code", function(e) {
							var code = e.keyCode || e.which;
							 if(code == 13) {
							   customerSearch(customerFields, customerSearchfields);
							 }
						});

					$('body').on('change', "#customer-form-code", function(e) {
						   customerSearch(customerFields, customerSearchfields);
					});

					$('body').on('click', "[id^='listCustomers-field-button-select-']", function(e) {
						$("#customer-form-code").val($(this).parent().parent().parent().children('td').eq(1).text());
						$("#customer-form-code").trigger('change');
						$("#customer-search-modal-form").modal('toggle');
					});

					$('body').on('dblclick', "#listCustomers tr", function(e) {
						$("#customer-form-code").val($(this).children('td').eq(1).text());
						$("#customer-form-code").trigger('change');
						$("#customer-search-modal-form").modal('toggle');
					});

					$('body').on('change', "#customer-form-customergroup-select", function(e) {
						recalculateDocument();
					});

					{# PRODUCT SEARCH #}
					$('body').on('click', "[id^='product-search-button-']", function(e) {
						$("#product-search-modal-form").attr("attr-id",$(this).attr("attr-id"));
						$("#product-search-modal-form").modal('show');
					});

					$('body').on('keypress', "[id^='product-form-code-']", function(e) {
							var code = e.keyCode || e.which;
							 if(code == 13) {
								 productSearch($(this).attr("attr-id"), $(this).val(), productFields, productSearchfields);
							 }
						});
					$('body').on('change', "[id^='product-form-code-']", function(e) {
							 productSearch($(this).attr("attr-id"), $(this).val(), productFields, productSearchfields);
					});

					$('body').on('click', "[id^='listProducts-field-button-select-']", function(e) {
						$("#product-form-code-"+$("#product-search-modal-form").attr("attr-id")).val($(this).parent().parent().parent().children('td').eq(1).text());
						$("#product-form-code-"+$("#product-search-modal-form").attr("attr-id")).trigger('change');
						$("#product-search-modal-form").modal('toggle');
					});

					$('body').on('dblclick', "#listProducts tr", function(e) {
						$("#product-form-code-"+$("#product-search-modal-form").attr("attr-id")).val($(this).children('td').eq(1).text());
						$("#product-form-code-"+$("#product-search-modal-form").attr("attr-id")).trigger('change');
						$("#product-search-modal-form").modal('toggle');
					});

					$('body').on('change', "[id^='product-form-code-']", function(e) {
						if($(this).attr("attr-id")==$("#document-lines").attr("attr-numlines")){
							$("#product-form-remove-"+$(this).attr("attr-id")).show();
							addDocumentLine();
						}
					});

					$('body').on('focus', "[id^='product-search-button-']", function(e) {
							$("#product-form-name-"+$(this).attr("attr-id")).focus();
					});

					$('body').on('click', "[id^='product-form-remove-']", function(e) {
						removeDocumentLine($(this).attr('attr-id'));
					});

					$('body').on('change', "[id^='product-form-']", function(e) {
						if($(this).hasClass("recalculate")){
							calculateDocumentRow($(this).attr("attr-id"));
						}
					});


					{# DOCUMENT SAVE #}

					$('body').on('click', "#document-button-save", function(e) {
						var documentFields = new Object();
						var lines=[];
						documentFields.id=$("#document-form-id").val();
						documentFields.code=$("#document-form-code").val();
						documentFields.date=$("#document-form-date").val();
						documentFields.serie=$("#document-form-series-select").val();
						documentFields.paymentmethod=$("#customer-form-paymentmethod-select").val();
						documentFields.dateofferend=$("#document-form-dateofferend").val();
						documentFields.customercode=$("#document-form-customercode").val();
						documentFields.customerid=$("#customer-form-id").val();
						documentFields.customergroup=$("#customer-form-customergroup-select").val();
						documentFields.irpf=$("#customer-form-irpf").val();
						documentFields.irpfperc=$("#customer-form-irpf-perc").val();
						documentFields.surcharge=$("#customer-form-surcharge").val();
						documentFields.taxexempt=$("#customer-form-taxexempt").val();
						documentFields.totalnet=$("#totals_form_net").val();
						documentFields.totaldto=$("#totals_form_dto").val();
						documentFields.totaltax=$("#totals_form_tax").val();
						documentFields.totalsurcharge=$("#totals_form_surcharge").val();
						documentFields.totalirpf=$("#totals_form_irpf").val();
						documentFields.total=$("#totals_form_total").val();

						$("[id^='document-line-']").each(function() {
							var line = new Object();
							line.id=$(this).find("#product-form-line-id-"+$(this).attr("attr-id")).val();
							line.linenum=$(this).attr("attr-id");
							line.productid=$(this).find("#product-form-id-"+$(this).attr("attr-id")).val();
							line.code=$(this).find("#product-form-code-"+$(this).attr("attr-id")).val();
							line.name=$(this).find("#product-form-name-"+$(this).attr("attr-id")).val();
							line.unitprice=$(this).find("#product-form-price-"+$(this).attr("attr-id")).val();
							line.quantity=$(this).find("#product-form-quantity-"+$(this).attr("attr-id")).val();
							line.disccountperc=$(this).find("#product-form-disccount-"+$(this).attr("attr-id")).val();
							line.disccountunit=$(this).find("#product-form-disccount-total-"+$(this).attr("attr-id")).val();
							line.taxperc=$(this).find("#product-form-tax-"+$(this).attr("attr-id")).val();
							line.taxunit=$(this).find("#product-form-tax-total-"+$(this).attr("attr-id")).val();
							line.irpfperc=$(this).find("#customer-form-irpf-perc").val();
							line.irpfunit=$(this).find("#product-form-irpf-total-"+$(this).attr("attr-id")).val();
							line.surchargeperc=$(this).find("#product-form-surcharge-"+$(this).attr("attr-id")).val();
							line.surchargeunit=$(this).find("#product-form-surcharge-total-"+$(this).attr("attr-id")).val();
							line.subtotal=$(this).find("#product-form-base-total-"+$(this).attr("attr-id")).val();
							line.total=$(this).find("#product-form-amount-"+$(this).attr("attr-id")).val();
							line.deleted=$(this).hasClass('deleted');
							lines.push(line);
						});
						documentFields.lines=lines;
						console.log(JSON.stringify(documentFields));

						$.ajax({
			         url: '{{ url('dataAERPSalesBudgets', {"id": id}) }}',
			         type: 'POST',
			         data: JSON.stringify(documentFields),
			         success:  function( data ) {
								 if((--load_wait)==0) $("#load-spinner").fadeOut();
			           if(data.result){
									 $("#document-form-id").val(data.data.id);
									 $("#document-form-code").val(data.data.code);
									 $("#document-form-date").val(data.data.date);
									 jQuery.each(data.data.lines, function(i, line) {
										 $("#product-form-line-id-"+line.linenum).val(line.id);
									 });
									 toastr.success("Documento guardado correctamente", "Confirmaci√≥n", confirmation);
			           } else {
									 toastr.error("No se pudo guardar el documento", "Confirmaci√≥n", confirmation);
								 }
			         }
			       });

					 });

			});

		</script>

<!-- END MODALS -->
{% block footer %}

<link rel="stylesheet" href="{{ url('index') }}js/datatables/datatables.css">
<link rel="stylesheet" href="{{ url('index') }}js/select2/select2-bootstrap.css">
<link rel="stylesheet" href="{{ url('index') }}js/select2/select2.css">
<link rel="stylesheet" href="{{ url('index') }}css/custom.css">
<link rel="stylesheet" href="{{ url('index') }}js/ol/ol.css">
<link rel="stylesheet" href="{{ url('index') }}js/datetimepicker/bootstrap-datetimepicker.min.css">
<!-- Imported scripts on this page -->
<script src="{{ url('index') }}js/datatables/datatables.js"></script>
<script src="{{ url('index') }}js/select2/select2.min.js"></script>
<script src="{{ url('index') }}js/moment.min.js"></script>
<script src="{{ url('index') }}js/moment-es.js"></script>
<script src="{{ url('index') }}js/datetimepicker/bootstrap-datetimepicker-es.js"></script>
<script src="{{ url('index') }}js/datetimepicker/bootstrap-datetimepicker.min.js"></script>
<script src="{{ url('index') }}js/fileinput.js"></script>
<script src="{{ url('index') }}js/ol/ol.js"></script>
	 {{ include('@Globale/bottom.html.twig') }}
{% endblock %}
</body>
